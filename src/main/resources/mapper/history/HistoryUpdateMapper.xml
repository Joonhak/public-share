<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.slam.mapper.history.HistoryUpdateMapper">

    <update id="updateHistory">
        UPDATE /* historyMapper.updateHistory */
               BOOK_HISTORY
           SET REQUESTED_STATUS = #{requestedStatus}
               , STARTED_AT = CASE
                   WHEN STARTED_AT is NULL THEN NOW()
                   ELSE STARTED_AT
               END
               , MODIFIED_BY = #{modifiedBy}
               , MODIFIED_AT = NOW()
         WHERE ID = #{id}
           AND BOOK_ID = #{bookId}
    </update>

    <update id="conditionalUpdateHistory">
        UPDATE /* historyMapper.conditionalUpdateHistory */
               BOOK_HISTORY
           SET REQUESTED_STATUS = CASE
               <choose>
                   <when test="requestedStatus.toString() == 'RETURNED'">
                       WHEN REQUESTED_STATUS = 'RETURN_REQUEST' THEN 'RETURNED'
                   </when>
                   <when test="requestedStatus.toString() == 'REJECTED'">
                       WHEN REQUESTED_STATUS = 'WAIT_FOR_RESPONSE' THEN 'REJECTED'
                   </when>
                   <otherwise>
                       WHEN REQUESTED_STATUS = 'WAIT_FOR_RESPONSE' THEN 'CANCELED'
                   </otherwise>
               </choose>
                   WHEN REQUESTED_STATUS = 'ON_RESERVED' THEN 'WAIT_FOR_RESPONSE'
                   ELSE REQUESTED_STATUS
               END
               , ENDED_AT = CASE
                   WHEN REQUESTED_STATUS IN ('RETURNED', 'REJECTED', 'CANCELED') THEN NOW()
                   ELSE ENDED_AT
               END
               , MODIFIED_BY = #{modifiedBy}
               , MODIFIED_AT = NOW()
         WHERE BOOK_ID = #{bookId}
               <choose>
                   <when test="requestedStatus.toString() == 'RETURNED'">
                       AND REQUESTED_STATUS IN ('RETURN_REQUEST', 'WAIT_FOR_RESPONSE')
                   </when>
                   <otherwise>
                       AND REQUESTED_STATUS IN ('WAIT_FOR_RESPONSE', 'ON_RESERVED')
                   </otherwise>
               </choose>
      ORDER BY REQUESTED_AT ASC
         LIMIT 2
    </update>
    <!--
        <update id="updateBookHistoryToOnLoan">
            UPDATE /* historyMapper.updateBookHistoryToOnLoan */
                   BOOK_HISTORY
               SET REQUESTED_STATUS = #{requestedStatus}
                   , STARTED_AT = NOW()
             WHERE ID = #{id}
        </update>

        <update id="updateBookHistoryStatus">
            UPDATE /* historyMapper.updateBookHistoryStatus */
                   BOOK_HISTORY
               SET REQUESTED_STATUS = #{requestedStatus}
                   , ENDED_AT = NOW()
             WHERE ID = #{id}
        </update>
    -->
</mapper>