<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <th:block th:replace="include/head :: head"/>
    <title th:text="|${book.title} :: Public Share|"></title>
    <style type="text/css">
      #description {
        resize: none;
      }

      .comment-input {
        flex: 1;
        margin-bottom: .5rem;
        padding: .5rem;
        resize: none;
        border-radius: 9px;
        min-height: 50px;
      }

      div.align-items-start {
        padding: 1rem;
      }

      textarea + button.btn-success {
        border-radius: 9px;
      }

      .thumbnail {
        width: 25%;
      }

      .comment-text {
        word-break: break-word;
        white-space: normal;
      }

      small.btn-link {
        cursor: pointer;
      }

      #load-more {
        text-align: center;
        cursor: pointer;
        padding: 1rem 0;
      }

      #load-more span::before {
        opacity: 0;
        content: '⇣';
        -webkit-transition: opacity .2s ease-in;
        -moz-transition: opacity .2s ease-in;
        -o-transition: opacity .2s ease-in;
        -ms-transition: opacity .2s ease-in;
        transition: opacity .2s ease-in;
      }

      #load-more:hover span::before {
        opacity: 1;
      }
    </style>
  </head>
  <body>

    <div th:if="${session?.auth != null && book.createdBy == session.auth.username}" class="modal fade" id="history-modal"
         tabindex="-1" role="dialog"
         aria-labelledby="history-modal" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">History</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <p>No result to show</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <!--<button type="button" class="btn btn-primary">Save changes</button>-->
          </div>
        </div>
      </div>
    </div>

    <div th:if="${session?.auth == null}" class="modal fade" id="alert-modal" tabindex="-1" role="dialog"
         aria-labelledby="alert-modal" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">You Need Sign-in!</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <p>Need sign in for this action</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="window.location = '/sign-in';">Go to Sign in page
            </button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <section th:replace="include/header :: header"></section>

    <div class="album py-5">
      <div class="container">
        <div class="row mb-5">
          <div class="col-6">
            <img class="img-fluid main-image" th:src="@{|http://img.worksout.co.kr/${book.mainImage}|}"
                 th:alt="${book.title}">
            <div class="images">
              <img class="thumbnail" th:each="i : ${book.images}" th:src="@{|http://img.worksout.co.kr/${i.imageUrl}|}"
                   th:alt="${book.title}" th:attr="data-src=${i.imageUrl}"/>
            </div>
          </div>
          <div class="col-6">
            <h1 th:text="${book.title}"></h1>
            <span th:text="${book.author}"></span>
            <p th:text="${book.createdBy}"></p>
            <!--<div th:utext="*{#strings.replace(book.description, T(System).getProperty('line.separator'), '&lt;br/&gt;')}" class="my-3">-->
            <!-- for textarea's data.. do i must write like below? -->
            <!--</div>-->
            <textarea id="description" class="form-control-plaintext" th:text="${book.description}" disabled></textarea>
            <script type="text/javascript">
              $('#description').height(document.querySelector('#description').scrollHeight);
            </script>

            <div th:if="${session?.auth != null && session.auth.username != book.createdBy}" id="btn-div">
              <button class="btn btn-success col-md-6 col-12" data-type="WAIT_FOR_RESPONSE" th:if="${book.status == T(org.slam.dto.book.BookStatus).AVAILABLE}">
                대여하기
              </button>

              <th:block th:if="${book.status != T(org.slam.dto.book.BookStatus).AVAILABLE}">
                <th:block th:if="${book.recentLoaner == session.auth.username}">
                  <th:block th:switch="${book.status}">
                    <button class="btn btn-outline-danger col-md-6 col-12" data-type="RETURN_REQUEST" th:case="${T(org.slam.dto.book.BookStatus).ON_LOAN}">
                      반납하기
                    </button>
                    <button class="btn btn-outline-danger col-md-6 col-12" data-type="CANCELED" th:case="*"> <!-- ${T(org.slam.dto.book.BookStatus).WAIT_FOR_RESPONSE} -->
                      신청취소
                    </button>
                    <!--
                    <button class="btn btn-outline-danger col-md-6 col-12" data-type="RETURN_CANCELED" th:case="T(org.slam.dto.book.BookStatus).RETURN_REQUEST">
                      반납취소
                    </button>
                    -->
                  </th:block>
                </th:block>

                <th:block th:if="${book.recentLoaner != session.auth.username}">
                  <button class="btn btn-outline-danger col-md-6 col-12" data-type="CANCELED" th:if="${book.isReserved}">예약취소</button>
                  <button class="btn btn-outline-success col-md-6 col-12" data-type="ON_RESERVED" th:if="${!book.isReserved}">예약하기</button>
                </th:block>
              </th:block>
            </div>

            <div th:if="${session?.auth != null && session.auth.username == book.createdBy}">
              <button id="see-history" class="btn btn-info col-md-6 col-12" data-toggle="modal" data-target="#history-modal">
                History
              </button>
            </div>

            <div th:if="${session == null || session.auth == null}">
              <a href="/sign-in" data-toggle="tooltip" data-placement="top" title="Sign in first!"
                 class="btn btn-success col-md-6 col-12">
                대여하기
              </a>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <div class="container">
              <form id="comment-form" class="row justify-content-end" th:action="@{|/comment/${book.id}|}" method="post">
                <input type="hidden" name="createdBy" th:value="${session?.auth?.username}">
                <textarea class="col-12 comment-input" data-toggle="tooltip" name="comment"></textarea>
                <button id="register-comment" type="submit" class="btn btn-success col-md-1 col-12" data-toggle="tooltip"
                        style="margin-bottom: .5rem;">등록
                </button>
              </form>
              <div class="comments"></div>
              <div id="paginator"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer th:replace="include/footer :: footer"></footer>
    <th:block th:replace="include/scripts :: scripts"/>
    <script src="/js/paginator.js" type="text/javascript"></script>
    <th:block th:if="${session?.auth != null}">
      <script type="text/javascript" th:inline="javascript">
        $(function () {

          $('#btn-div button').click(function(e) {
            var data = setRequestData($(e.target).data('type'));
            var isNewRequest = data.requestedStatus === 'WAIT_FOR_RESPONSE' || data.requestedStatus === 'ON_RESERVED';
            var method = isNewRequest ? 'post' : 'patch';
            $.ajax({
              url: '/book/' + [[${book.id}]],
              type: method,
              data: data,
              success: function(res) {
                console.log(res);
                // if (res) {
                //   window.location.reload();
                //   alert('Success!');
                // } else {
                //   alert('Something went wrong.. try again after few minute');
                // }
              },
              error: function (xhr, e) {
                console.error(xhr);
                console.error(e);
                alert('Something went wrong... try again!');
              }
            })
          });

          function setRequestData(type) {
            return {
              modifiedBy: [[${session.auth.username}]],
              status: type,
              originStatus: [[${book.status}]]
            };
          }

          // $('#loan-btn').click(function (e) {
          //   if (!confirm('해당 도서를 대여하시겠습니까?')) return;
          //   $.ajax({
          //     url: '/book/[[${book.id}]]',
          //     type: 'post',
          //     data: {
          //       modifiedBy: [[${session.auth.username}]],
          //       status: 'WAIT_FOR_RESPONSE'
          //     },
          //     success: function (res) {
          //       if (res) {
          //         window.location.reload();
          //         alert('Success!');
          //       } else {
          //         alert('Something went wrong.. try again after few minute');
          //       }
          //     },
          //     error: function (xhr, e) {
          //       console.error(xhr);
          //       console.error(e);
          //       alert('Something went wrong... try again!');
          //     }
          //   });
          // });
          //
          // $('#resv-btn').click(function (e) {
          //   if (!confirm('해당 도서를 예약하시겠습니까?')) return;
          //   $.ajax({
          //     url: '/book/[[${book.id}]]',
          //     type: 'post',
          //     data: {
          //       modifiedBy: [[${session.auth.username}]],
          //       status: 'ON_RESERVED'
          //     },
          //     success: function (res) {
          //       if (res) {
          //         window.location.reload();
          //         alert('Success!');
          //       } else {
          //         alert('Something went wrong.. try again after few minute');
          //       }
          //     },
          //     error: function (xhr, e) {
          //       console.error(xhr);
          //       console.error(e);
          //       alert('Something went wrong... try again!');
          //     }
          //   });
          // });
          //
          // $('#resv-cancel-btn').click(function (e) {
          //   if (!confirm('해당 도서 예약을 취소하시겠습니까?')) return;
          //   $.ajax({
          //     url: '/book/[[${book.id}]]',
          //     type: 'patch',
          //     data: {
          //       modifiedBy: [[${session.auth.username}]],
          //       status: 'CANCELED'
          //     },
          //     success: function (res) {
          //       if (res) {
          //         window.location.reload();
          //         alert('Success!');
          //       } else {
          //         alert('Something went wrong.. try again after few minute');
          //       }
          //     },
          //     error: function (xhr, e) {
          //       console.error(xhr);
          //       console.error(e);
          //       alert('Something went wrong... try again!');
          //     }
          //   });
          // });
          //
          // $('#cancel-btn').click(function (e) {
          //   if (!confirm('대여요청을 취소하시겠습니까?')) return;
          //   $.ajax({
          //     url: '/book/[[${book.id}]]',
          //     type: 'patch',
          //     data: {
          //       modifiedBy: [[${session.auth.username}]],
          //       status: 'CANCELED'
          //     },
          //     success: function (res) {
          //       if (res) {
          //         window.location.reload();
          //         alert('Success!');
          //       } else {
          //         alert('Something went wrong.. try again after few minute');
          //       }
          //     },
          //     error: function (xhr, e) {
          //       console.error(xhr);
          //       console.error(e);
          //       alert('Something went wrong... try again!');
          //     }
          //   });
          // });
          //
          // $('#return-btn').click(function (e) {
          //   if (!confirm('도서를 반납하시겠습니까?')) return;
          //   $.ajax({
          //     url: '/book/[[${book.id}]]',
          //     type: 'patch',
          //     data: {
          //       modifiedBy: [[${session.auth.username}]],
          //       status: 'RETURN_REQUEST'
          //     },
          //     success: function (res) {
          //       if (res) {
          //         window.location.reload();
          //         alert('Success!');
          //       } else {
          //         alert('Something went wrong.. try again after few minute');
          //       }
          //     },
          //     error: function (xhr, e) {
          //       console.error(xhr);
          //       console.error(e);
          //       alert('Something went wrong... try again!');
          //     }
          //   });
          // });

          $('#see-history').click(function (e) {
            $.getJSON('/history/' + [[${book.id}]], function (res) {
              $('#history-modal .modal-body').html(makeHtmlForBookHistory(res));
            });
          });

          function makeHtmlForBookHistory(data) {
            var html = '';
            if (data.length) {
              data.forEach(function (d) {
                if ('WAIT_FOR_RESPONSE' === d.requestedStatus) d.requestedStatus = '대여요청';
                else if ('ON_RESERVED' === d.requestedStatus) d.requestedStatus = '예약';
                else if ('ON_LOAN' === d.requestedStatus) d.requestedStatus = '대여중';

                html += '<div class="py-2 row"><div class="col-7"><p>REQUEST USER : ';
                html += d.requestedUser + '</p><p>REQUEST STATUS : ' + d.requestedStatus + '</p></div>';
                if (d.requestedStatus === '대여요청') {
                  html += '<div class="col-5"><button id="accept-btn" class="btn btn-success" data-id="' + d.bookId + '">Accept</button>';
                  html += '<button id="reject-btn" class="btn btn-outline-secondary" data-id="' + d.bookId + '">Reject</button></div>';
                }
                html += '</div>';
              });
              html += '<a href="/book/' + data[0].bookId + '/histories">View all history</a></div>';
            } else html += '<div class="py-2 row"><span class="col-12 text-center font-weight-bold">No result</span></div>';
            return html;
          }

          $('#comment-form').submit(function (e) {
            e.preventDefault();
            saveComment($(this).serialize());
          });

          var $comments = $('.comments');
          $comments.on('click', '.remove-comment', function (e) {
            if (!confirm('해당 댓글을 삭제하시겠습니까?')) return;
            $.ajax({
              url: '/comment/[[${book.id}]]/' + $(this).parent().parent().data('comment-id'),
              type: 'delete',
              success: function (res) {
                if (res) {
                  getComments(page);
                } else {
                  alert('Something went wrong... try again!');
                }
              },
              error: function (xhr, e) {
                console.error(xhr);
                console.error(e);
                alert('Something went wrong... try again!');
              }
            });
          });

          $comments.on('click', '.add-reply', function (e) {
            var $parent = $(this).parent();
            if (!$parent.find('textarea').length) {
              $comments.find('textarea').parent().remove();
              $parent.append(makeTextareaForAddReply());
            } else {
              $parent.find('.row').remove();
            }
          });

          $comments.on('click', '.btn-success', function (e) {
            var comment = $comments.find('textarea').val();
            if (!comment || !comment.length) {
              alert('내용을 입력해주세요.');
              return;
            }

            var $dataParent = $(this).parent().parent().parent();
            var depth = $dataParent.data('depth') + 1;
            var groupOrder = $dataParent.data('group-order') + 1;

            if (depth > 1) { // 답글의 답글
              var isOriginComment = true;
              while (isOriginComment) {
                if ($dataParent.data('depth') === 0) {
                  isOriginComment = false;
                  break;
                }
                $dataParent = $dataParent.prev();
              }
            }

            var data = {
              bookId: [[${book.id}]]
              , parentId: $dataParent.data('comment-id')
              , groupOrder: groupOrder
              , depth: depth
              , comment: comment.trim()
              , createdBy: [[${session.auth.username}]]
            };
            saveComment(data);
          });

          function saveComment(data) {
            $.ajax({
              url: '/comment/[[${book.id}]]',
              data: data,
              type: 'post',
              success: function (res) {
                if (res) {
                  getComments(page);
                } else {
                  alert('Something went wrong... try again!');
                }
              },
              error: function (xhr, e) {
                console.error(xhr);
                console.error(e);
                alert('Something went wrong... try again!');
              }
            });
          }

        });
      </script>
    </th:block>
    <th:block th:if="${session?.auth == null}">
      <script type="text/javascript">
        $('[data-toggle="tooltip"]').click(function (e) {
          e.preventDefault();
          $('#alert-modal').modal();
        }).tooltip();
      </script>
    </th:block>
    <script type="text/javascript" th:inline="javascript">
      $('.thumbnail').click(function (e) {
        $('.main-image').attr('src', e.target.src);
      });

      var page;
      var itemList = [];
      var paginator;
      // var hasMore = true;
      getComments();

      $('#paginator').on('click', '[data-page]', function (e) {
        page = Number(e.target.dataset.page);
        if (itemList[page]) {
          $('.comments').append(makeCommentsHtml(itemList[page]));
          e.target.dataset.page = ++page;
        } else {
          if (paginator.next && paginator.end >= page) {
            getComments(++page);
          } else {
            $('#paginator').html('');
          }
        }
      });

      function getComments(page) {
        page = page || 1;
        $.getJSON('/comment/[[${book.id}]]?page=' + page, function (res) {
          if (res['comments'].length) {
            paginator = res['paginator'];
            itemList = itemList.concat(pageInit(res['comments'], paginator));
            $('.comments').append(makeCommentsHtml(itemList[page - 1]));
            $('#paginator').html(makeLoadMoreButton(page));
          }
        });
      }

      function makeCommentsHtml(data) {
        var html = '';
        data.forEach(function (d) {
          html += '<div class><div class="bg-light row rounded align-items-start" style="padding-left: ' + d.depth * 2 + 'rem"';
          html += 'data-comment-id="' + d.id + '" data-depth="' + d.depth + '" data-group-order="' + d.groupOrder + '">';
          html += '<img src="https://placeimg.com/50/50/animals" alt="Profile image" style="width: 50px;border-radius: 50%;margin-right: 15px;"><div style="flex: 1;">';
          html += '<p style="margin-bottom: .5rem;"><b class="mr-1">' + d.createdBy + '</b>';
          if ([[${book.createdBy}]] === d.createdBy) {
            html += '<span class="badge badge-pill badge-secondary">owner</span> |';
          }
          html += '<span>' + d.createdAt + '</span></p><div class="comment-text">' + d.comment + '</div>';
          if ([[${session?.auth}]]) {
            html += '<small class="mr-3 btn-link add-reply">답글달기</small>';
            if ([[${session?.auth?.username}]] === d.createdBy) {
              html += '<small class="btn-link text-danger remove-comment">삭제</small>';
            }
          }
          html += '</div></div></div>';
        });
        return html;
      }

      function makeLoadMoreButton(page) {
        return '<nav id="load-more" data-page="' + page + '">Load more <span>  </span></nav>';
      }

      function makeTextareaForAddReply() {
        var html = '<div class="row"><textarea class="col-12 comment-input"></textarea>';
        html += '<button class="btn btn-success col-md-1 col-12" style="margin-bottom: .5rem;font-size: 13px;">등록</button></div>';
        return html;
      }
    </script>
  </body>
</html>